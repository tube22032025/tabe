#!/bin/bash

# Kiểm tra và chuyển sang quyền root nếu cần
if [ "$(id -u)" != "0" ]; then
   echo "Chuyển sang quyền root..."
   exec sudo su -c "$0"
   exit
fi

# Hàm xử lý lỗi
handle_error() {
    local exit_code=$1
    local error_message=$2
    if [ $exit_code -ne 0 ]; then
        echo "LỖI: $error_message" >&2
        exit $exit_code
    fi
}

# Cập nhật và cài đặt các gói cần thiết
echo "Cập nhật hệ thống..."
apt update
handle_error $? "Không thể cập nhật hệ thống"

echo "Cài đặt các gói cần thiết..."
apt install -y python3-pip python3-flask python3-apscheduler cron lsof
handle_error $? "Không thể cài đặt các gói cần thiết"

# Cài đặt pytubefix và gunicorn
echo "Cài đặt pytubefix và gunicorn..."
pip install pytubefix --break-system-packages
handle_error $? "Không thể cài đặt pytubefix"
pip install gunicorn --break-system-packages
handle_error $? "Không thể cài đặt gunicorn"

# Tạo file youtube.py
echo "Tạo file youtube.py..."
curl -s https://raw.githubusercontent.com/tube22032025/tube/refs/heads/main/tube.py > youtube.py
handle_error $? "Không thể tải file tube.py"

# Tạo thư mục templates và file index.html
echo "Tạo thư mục templates và file index.html..."
mkdir -p templates
handle_error $? "Không thể tạo thư mục templates"
curl -s https://raw.githubusercontent.com/tube22032025/tube/refs/heads/main/index.html > templates/index.html
handle_error $? "Không thể tải file index.html"

# Kiểm tra và giải phóng cổng 80 nếu đã được sử dụng
echo "Kiểm tra cổng 80..."
if lsof -i :80 > /dev/null 2>&1; then
    echo "Cổng 80 đang được sử dụng. Đang giải phóng..."
    fuser -k 80/tcp
    sleep 2
fi

# Tạo file test_cron.sh
echo "Tạo file test_cron.sh..."
cat > /root/test_cron.sh << 'EOL'
#!/bin/bash
# Kiểm tra xem Gunicorn có đang chạy không
if ! pgrep -f "gunicorn.*youtube:app" > /dev/null; then
    echo "$(date): Gunicorn không chạy. Đang khởi động lại..." >> /root/youtube_cron.log
    fuser -k 80/tcp 2>/dev/null
    /usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 youtube:app >> /root/youtube_cron.log 2>&1 &
fi
EOL
chmod +x /root/test_cron.sh
handle_error $? "Không thể tạo hoặc cấp quyền cho file test_cron.sh"

# Cấu hình crontab
echo "Cấu hình crontab..."
(crontab -l 2>/dev/null | grep -v "youtube\|gunicorn"; 
echo "@reboot /usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 youtube:app >> /root/youtube_cron.log 2>&1"; 
echo "* * * * * /root/test_cron.sh") | crontab -
handle_error $? "Không thể cấu hình crontab"

# Chạy Gunicorn
echo "Chạy Gunicorn..."
/usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 youtube:app >> /root/youtube_cron.log 2>&1 &
handle_error $? "Không thể chạy Gunicorn"

echo "Cài đặt hoàn tất! Ứng dụng đang chạy trên cổng 80."
echo "Kiểm tra log tại: /root/youtube_cron.log"
