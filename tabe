#!/bin/bash

# Kiểm tra và chuyển sang quyền root nếu cần
if [ "$(id -u)" != "0" ]; then
   echo "Chuyển sang quyền root..."
   exec sudo su -c "$0"
   exit
fi

# Xác định thư mục hiện tại để sử dụng trong crontab
CURRENT_DIR=$(pwd)
echo "Thư mục hiện tại: $CURRENT_DIR"

# Cập nhật và cài đặt các gói cần thiết
echo "Cập nhật và cài đặt các gói cần thiết..."
apt update
apt install -y python3-pip python3-flask python3-apscheduler cron

# Cài đặt gunicorn và pytubefix với --break-system-packages
echo "Đang cài đặt gunicorn..."
pip install --break-system-packages gunicorn

echo "Đang cài đặt pytubefix..."
pip install pytubefix --break-system-packages

# Tạo file youtube.py
echo "Tạo file youtube.py..."
curl -s https://raw.githubusercontent.com/tube22032025/tube/refs/heads/main/tube.py > youtube.py

# Đảm bảo file có quyền thực thi
echo "Cấp quyền thực thi cho file..."
chmod +x youtube.py

# Tạo thư mục templates và file index.html
echo "Tạo thư mục templates và file index.html..."
mkdir -p templates
curl -s https://raw.githubusercontent.com/tube22032025/tube/refs/heads/main/index.html > templates/index.html

# Thêm shebang vào đầu file youtube.py nếu chưa có
if ! grep -q "^#!/usr/bin/python3" youtube.py; then
    sed -i '1i#!/usr/bin/python3' youtube.py
    echo "Đã thêm shebang vào youtube.py"
fi

# Cấu hình crontab với đường dẫn đầy đủ
echo "Cấu hình crontab với đường dẫn: $CURRENT_DIR"
(crontab -l 2>/dev/null | grep -v "youtube.py"; echo "@reboot /usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 youtube:app >> /root/youtube_cron.log 2>&1") | crontab -
(crontab -l 2>/dev/null | grep -v "test_cron.sh"; echo "* * * * * /root/test_cron.sh") | crontab -

# Kiểm tra crontab
echo "Crontab đã được cấu hình:"
crontab -l

# Kiểm tra quyền truy cập của người dùng với cron
if [ -f /etc/cron.deny ]; then
    if grep -q "$(whoami)" /etc/cron.deny; then
        echo "CẢNH BÁO: Người dùng $(whoami) bị cấm sử dụng cron trong /etc/cron.deny"
    fi
fi

if [ -f /etc/cron.allow ]; then
    if ! grep -q "$(whoami)" /etc/cron.allow; then
        echo "CẢNH BÁO: Người dùng $(whoami) không được phép sử dụng cron trong /etc/cron.allow"
    fi
fi

# Kiểm tra xem cron service có đang chạy không
if ! systemctl is-active --quiet cron; then
    echo "CẢNH BÁO: Dịch vụ cron không hoạt động. Đang kích hoạt..."
    systemctl enable cron
    systemctl start cron
fi

# Tạo file test để kiểm tra cron
echo "Tạo file test để kiểm tra cron..."
cat > test_cron.sh << EOL
#!/bin/bash
echo "Cron test executed at \$(date)" >> $CURRENT_DIR/cron_test.log
EOL
chmod +x test_cron.sh

# Chạy gunicorn ngay lập tức cho lần cài đặt đầu tiên
echo "Chạy gunicorn với 4 workers trên 0.0.0.0:80..."
/usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 youtube:app &

echo "Đã thêm test cron job. Kiểm tra file cron_test.log sau 1 phút để xác nhận cron đang hoạt động."

