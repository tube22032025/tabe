#!/bin/bash

# Kiểm tra và chuyển sang quyền root nếu cần
if [ "$(id -u)" != "0" ]; then
   echo "Chuyển sang quyền root..."
   exec sudo "$0"
   exit
fi

# Xác định thư mục hiện tại để sử dụng trong crontab
CURRENT_DIR=$(pwd)
echo "Thư mục hiện tại: $CURRENT_DIR"

# Cập nhật và cài đặt các gói cần thiết
echo "Cập nhật và cài đặt các gói cần thiết..."
apt update
apt install -y python3-pip python3-flask python3-apscheduler cron

# Cài đặt gunicorn và pytubefix với --break-system-packages
echo "Đang cài đặt gunicorn..."
pip install --break-system-packages gunicorn

echo "Đang cài đặt pytubefix..."
pip install --break-system-packages pytubefix

# Tạo file youtube.py
echo "Tạo file youtube.py..."
curl -s https://raw.githubusercontent.com/tube22032025/tube/refs/heads/main/tube.py -o youtube.py

# Đảm bảo file có quyền thực thi
echo "Cấp quyền thực thi cho file..."
chmod +x youtube.py

# Tạo thư mục templates nếu chưa tồn tại và kiểm tra tệp 404.html
TEMPLATES_DIR="$CURRENT_DIR/templates"
if [ ! -d "$TEMPLATES_DIR" ]; then
    echo "Thư mục templates không tồn tại. Đang tạo thư mục..."
    mkdir -p "$TEMPLATES_DIR"
fi

if [ ! -f "$TEMPLATES_DIR/404.html" ]; then
    echo "Tệp 404.html không tồn tại trong thư mục templates. Đang tạo tệp 404.html..."
    cat > "$TEMPLATES_DIR/404.html" << EOL
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>404 Not Found</title>
</head>
<body>
    <h1>404 Not Found</h1>
    <p>The page you are looking for does not exist.</p>
</body>
</html>
EOL
else
    echo "Tệp 404.html đã tồn tại trong thư mục templates."
fi

# Thêm shebang vào đầu file youtube.py nếu chưa có
if ! grep -q "^#!/usr/bin/python3" youtube.py; then
    sed -i '1i#!/usr/bin/python3' youtube.py
    echo "Đã thêm shebang vào youtube.py"
fi

# Cấu hình crontab với đường dẫn đầy đủ đến youtube.py
echo "Cấu hình crontab với đường dẫn: $CURRENT_DIR"
(crontab -l 2>/dev/null | grep -v "youtube.py"; echo "@reboot /usr/local/bin/gunicorn --workers 4 --bind 0.0.0.0:80 $CURRENT_DIR/youtube.py:app >> /root/youtube_cron.log 2>&1") | crontab -
(crontab -l 2>/dev/null | grep -v "test_cron.sh"; echo "* * * * * $CURRENT_DIR/test_cron.sh") | crontab -

# Kiểm tra crontab
echo "Crontab đã được cấu hình:"
crontab -l

# Kiểm tra quyền truy cập của người dùng với cron
if [ -f /etc/cron.deny ]; then
    if grep -q "$(whoami)" /etc/cron.deny; then
        echo "CẢNH BÁO: Người dùng $(whoami) bị cấm sử dụng cron trong /etc/cron.deny"
    fi
fi

if [ -f /etc/cron.allow ]; then
    if ! grep -q "$(whoami)" /etc/cron.allow; then
        echo "CẢNH BÁO: Người dùng $(whoami) không được phép sử dụng cron trong /etc/cron.allow"
    fi
fi

# Kiểm tra xem cron service có đang chạy không
if ! systemctl is-active --quiet cron; then
    echo "CẢNH BÁO: Dịch vụ cron không hoạt động. Đang kích hoạt..."
    systemctl enable cron
    systemctl start cron
fi

# Tạo file test để kiểm tra cron
echo "Tạo file test để kiểm tra cron..."
cat > test_cron.sh << EOL
#!/bin/bash
echo "Cron test executed at \$(date)" >> $CURRENT_DIR/cron_test.log
EOL
chmod +x test_cron.sh

echo "Đã thêm test cron job. Kiểm tra file cron_test.log sau 1 phút để xác nhận cron đang hoạt động."
